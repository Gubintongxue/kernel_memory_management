好的那首先啊欢迎各位朋友来到铃声交易啊
我是维克
那么这节课主要是给大家分享的是内核
源码分析里面的一个啊
内存管理当中的八大模块
那么这八大模块呢上一次课啊
我已经给大家讲好了
第一个是页表缓存和处理器缓存
我们全部讲完了
并且包括里面的野马啊
它如何进行实现
对不对
一直到后面再来啊
那么这节课的话呢
我们主要是在学习啊
第二大点这个是什么呢
伙伴分配器跟那个什么呢
快分配器啊
其中快分配器分配器又分为什么呢
三个等等哈
那如果大家啊今天是第一次课啊
来听我讲的
那么各位朋友就直接什么呢
找这个贝贝老师来领取这个课堂笔记啊
那我给他准备好的这个五个电子档啊
五个电子档的这个内核源码分析
那里面我们已经标注的核心重点
是不是以及什么呢
一个是内存管理架构的这个笔记
还有一个是网络协议站
那么这些相关的所有资料啊
我就发到我们的公群里面
大家直接找这个啊
602878196
是不是这个啊
微信啊
QQ是啊
3008013361是吧
那现在的话我们主要是为我们的课堂为主
那么虎八分配器在学这个伙伴分配器之前啊
那我就给大家分享一个内容
什么内容呢
就说这个内存分配和回收在整个过程当中
那我们要注意的一个核心点是什么呢
那我们注意啊
就是说在内存初始化
LINUX内核
内存初始化完成之后
那么内存呢内存当中就常驻在我们内核的印象
就是相当于在内核的代码和数据
就这个意思
然后呢啊之后啊它随着什么呢
随着我们这个用户应用程序的执行和结束
就需要不断的什么分配和释放这个物理页面
那么内核他应该为分配组连续的一个页面啊
而且建立一种非常高效的啊
比如稳定的一个什么来分配策略
那么这个时候我们就必须什么呢
我们就必须解决一个比较非常重要的问题
就是内存管理问题
那么另外还有就是外碎片问题
比如我们循环了请求和释放
不同大小的一个联系页面的话
它必然会导致什么呢
导致我们这个已经分配的内存啊
这个内存块当中
它分散很多很多个小块的一个空闲页面啊
这样的话呢它又大了一个问题是什么呢
即使这些小块的空闲页面啊
如果我们把它夹起来
把它合起来的话
它也能够满足我们请求这个页面的要求
如果太多的情况下
但是我们要分配一个大块的联系页面
他可能没办法满足
是不是
所以说我们就提出了一个问题
叫做什么叫做伙伴系统算法
来解决这个什么碎片问题
现在我们了解第一个问题啊
就是那个伙伴伙伴系统算法
那么它是用来什么
是用来解决这个Y碎片问题
OK但是呢我们要注意在LINUX当中
CPU不能按照物理地址来访问我们这个存储空间
就是基础性的啊
基础的一些内容
但是必须要使用什么虚拟地址
所以说我们对内存页面的管理一般是什么呢
是先在虚拟空间中分配一个虚拟区域
然后再根据这个什么呢
根据这个西药啊
为它分为这个为这个区间来分配一个物理页面
并且给他建立一个什么映射
也就是说虚拟期间分配在前
物理页面分配在后
就这么个意思
所以我们后面一个概念叫做什么叫做虚拟存储
叫做虚存哎
我们这个虚城虚成这个期间
它是分配在什么在前面的
还有一个什么呀
物理页面它是分配在什么
分配在后
就这么一个原则
所以说我们现在要了解的就是第一个问题
它就是什么
就是这个伙伴算法
那么这个伙伴算法是这样的啊
就相当于什么呢
就相当于我们LINUXLINUX这个什么呢
他这个伙伴算法它是把什么
把所有的这个空闲页面
对不对
直接把它分为什么
分为十个
分为十个快组
对不对
但是每一组每组当中的这个快它的大小是什么
是二的
我们叫做二的幂次方
那个页面是不是
这就很容易理解了
那么比如第零组啊
我举个例子是不是
比如我们第零组
比如你这个零组是不是啊
你零组的话它的大小就是相当于二的零次方
就是一个页面
就这个意思
一个页面啊
好那如果你是第一组的话
那就是二的一次方
那就是两个页面啊
它是从零开始
它是0~9
00~9
那么0~9的话
那么他这个块的大小那就相当于什么
相当于我们刚刚讲的啊
这二的多少呢
最大嘛就是二的九次方
二的九次方
那就等于512个页面
等于512个页面
也就是说每一组当中这个块的大小都是相同的
而且这个同样的大小块就是同样的大小块啊
它就形成一个什么
形成一个链表
所以说啊所以说就是说这个所以说这个例子啊
就说什么意思呢
你比如你按了多少次
换多少次方
是不是他就把510个A
把512就分成512个页面嗯
一块链表
那如果你是这256万7
256
那个链表是不是它就分成说你想想要哪个部分
就取哪个部分
就这个意思
那现在我就举个例子啊
这个伙伴算法它有个原则是什么原则呢
是这样的
就是首先我们要满足是不是满足啊
满足这个条件啊
才称为什么呢
才称为这个伙伴嗯
哪些条件呢
第一个是两块啊
两块嗯
两个块它的一个什么大小啊
一定要相同
这是第一个
第二个就是说你两个快的一个什么呢
物理地址他要什么呢
他连续就说你满足这两个条件
那才叫做伙伴
你比如啊你比如什么问题呢
假设我们是你这个是多少呢
假设你是举个例子
假设你是128个页面的那个列表
对不对
另外一个是什么呢
另外一个是啊
假设是啊
两个页面的链表
这是一块链表
是不是你这一块链表
你这两个是连不到一块的
所以它就不满足这个伙伴的要求
就这个意思啊
除非你把128拆拆拆拆拆拆拆拆到什么呢
拆到这个啊两个页面
那么他们两个才能够形成就这么个意思
所以说接下来我们看个例子啊
什么例子呢啊我直接讲啊
直接讲我就不再一个一个写了啊
那现在我们的目标要求是什么呢
假设我要分配一个快
那么这个块的分配大小我要求是什么
要求是128个页面
现在我想分配128个页面啊
嗯那么128个页面
它是由很多个页面组成的块
我们才叫做页面块
就这个意思
那么这个伙伴算法它的工作原理
首先首先他要在这个快128个页面
列表当中来查找
首先第一个啊
他必须要到128个这个页面的
这个列表当中去找
看有没有128个
是不是
那看是否有这么一个空闲的这个140
28这个页面
那如果有就直接分配
如果没有
那这个算法就会就会什么
就会查找一个更大的空间
那么就会什么呢
如果这个有的话
它就OK了
就直接分配了
是不是
那如果没有的话呢
NO是不是没有以色列推啊
没有的话
那我就到手了
就到256了
我就走到这一条线来了
就这么个意思
那就到256好
那么这个时候他就应该什么呢
找到256
首先将256啊
将256分成两个等级
一个128
一个120个128
就这个意思嗯
他思路就是这样的啊
那么然后再什么呢
如果这样的空闲是不是内核
他就把什么把这个256分成两个等份
一份分出去
对不对
另外一份就超过128个页面
那么如果这个块的大小256个页面
这个列表当中他也没有找到空闲块
对不对啊
如果有啊
如果有的话
那就分配分为两个120帮忙
是不是啊
一个空前没录取
那如果你256没有的话
那么就直接出来直接到512了
是不是就是直接到512那个链表里面去查找
这个快是不是好
那么如果存在这样的一块话
内核就直接分配512个页面当中
分成两个
是不是分分出什么呢
你要将512分成一个128
对不对
你分成一个128的话
那么那你还剩下什么呢
你还剩下384了
因为你510个嘛
384
那么现在你要讲什么呢
384
当你要取出一个二五十六
你要拿出一个256出来
对不对
差不多256
这个页面再拿出个128
超到128那个页面
最后你总结总起来你不能超过256
是这个意思啊
把整体思路就这样了啊
所以说啊如果你这个512
是不是这个空间都没有了
对不对
那这个算好的
就放弃这个分配
他就会向我们这个用户啊发出一个什么
发出错误信号
他整个思路就这个过程
那么这个过程如果啊如果是相反过程
刚才设的过去
如果反过来的话
那就是释放过程
所以所以说这个什么呢
满足条件
这个伙伴算法它的满足条件写在前面啊
就是伙伴啊
伙伴满足的条件为两个
是不是
OK那这个问题我们理解之后啊
大家有时间的时候可以多研究一下
是不是
那么伙伴系统的这个算法它有整套数据结构
是不是
那么这个数据结构之间
它可以进行划分成各种各样的这个要求
所以第一个问题
那么这个伙伴系统的算法
我就给大家补充到这里
那么接下来什么呢
接下来我们看第二个啊
第二个
第二个就是我们要学习的一个什么伙伴嗯
伙伴分配器
那么伙伴分配器什么意思
就相当于比如这个LINUX啊
他的一个什么LINUX内核
它初始化初始化完成之后
下一步是什么呢
我们要使用这个液分配器来管理什么呢
来管理这个物理页了
你没有液分配器
你无法管理我们这个内存啊
所以说当我们使用液分配器
他就是什么
就是虎八分配器
就是当前目前目前我们使用这个液分配器嗯
是什么呢
是虎棒分配器
就这么个意思
是不是
但是为什么他选择这个虎八分配器呢
原因非常简单
因为火伴分配器它的特点是什么
算法比较简单
效率比较高
刚才已经讲过了
是不是啊
这是它的一个最基本的一个什么概念
包括它的一个原理
我们讲的很清楚了
是不是好
那么还有什么呢
这个伙伴基本的一个伙伴算法
刚才我们已经讲过了啊
大家来看一下
那么接着我们继续来继续来
什么意思呢
比如啊这个连续对不对
连续的一个什么你联系的一个物理嗯
联系物理业我们就称为什么称为这个液块
要搞清楚这是一块叫patch block
是不是还有一个刚才挨的多少次方嘛
我们叫做JO
是不是J接它是什么呢
结是我们伙伴分配器的一个什么啊
互换分配器的一个啊引用术语
是不是就是它的一个专业术语了
红包分配器专业术语就这个意思就这么解释了
是不是接术术语是吧好
但是要注意了
他是什么呢
是我们这个页的数量单位是叶啊
是叶的一个数量单位
但是我们经常讲的
比如二的多少
二的N次方是吧
等一下啊
二的好N次方
对不对
二的N次方各连续的一个什么呢
连续的一个页我们就称之为什么称为N阶页
N阶叶块
就这个意思
他思路其实很简单是吧
那么满足啊
满足刚才我讲了满足两个条件
就是以满足两个条件
那就称为什么称为N阶一块的一个什么互换
其实跟这个思路是一样的
是不是啊
所以说下面就是什么呢
就是满足几个呢
至少也要满足两个条件
两个条件是不是才可以啊
就是两个了
两个N阶
好两个N阶这个什么呢
一块就称为什么称为这个火罐
有的地方就没有
你是不是就写这么一个操作好
那么完成这个之后呢
那么哪两个呢
第一个就是两个块
对不对
你两个一块的一定是什么
一定要相明
这是他的第一个什么啊
最基本的条件
并且它的一个什么物理地址是连续的
这是第一个条件
那么第二个呢
我们这一块的第一页的一个物理页号
必须是什么二的N次方
N次方的一个什么
必须是整数倍
二是不是啊
一直往后面啊
二的整数倍
那么第三个是不是就是如果啊
如果如果我们要合并成什么呢
合并成括号
它有个什么N加一阶
是不是有这个操作
N加一阶这个一块
N加一好
N加一阶这个液块
那么第一个物理页号它就必须什么呢
必须是这个二的括号啊
N加一次方
N加一次方的一个什么整数倍
哎
他就这个意思是不是OK啊
这个可以可以射出来了
可以设出来了
是不是
那么以此类推啊
以此类推
这个不好打
是不是减一嘛
从零开始是吧
好如果你是二的
你是十吗
是不是十
那从零开始减一嘛
就这个意思是不是那家人们往后面看啊
这就是什么呢
现在我们所看到这个
他就是我们所讲的一个什么火伴分配器啊
它的一个最基本条件好
那我们了解他这个最基本条件之后
你要搞清楚
所以说比如啊0号液
一号液它是伙伴
是不是就这个意思吧
比如啊什么意思呢
比如0号零号和啊
比如0号和一号
你们两个是伙伴
是不是
那你2号和3号是伙伴呢
对不对
但是你一号和什么呢
一号和2号他不是伙伴
为什么呢
因为你两个不是一块的
是不是
所以说因为什么
因为一号和2号合并成一个液晶
就是乘一阶也快了
所以第一个月的那个物理也好
它不是二的整数倍
所以说这两个它是伙伴
那么一二它不是伙伴
所以我们要搞清楚这个关系就行了
那么伙伴分配器它分配和释放这个物理业单位
他也是接要搞清楚
这是第三个问题
要注意的
就是这个伙伴分配器
它所分配和释放的一个什么呢
物理液的一个什么数量单位
为什么呢
为JK好
那现在啊
现在我们将这个部分
我们基本上掌握和了解之后
那接下来我们就来看下一个
但是具体怎么分配
它有整套算法
大家可以看一下这个相关的算法
这个数据里面就有
是不是
那现在我们来看一下内核
要注意啊
内核在基本的火嘛分配器基础上
他又可以做了一些扩充
就把它扩展起来
就是知识内存节点和这个区域
就称为什么虎八分配区域
就分期虎八分配区域啊
那么他为了什么呢
比如为了一黄这个内存是一片
看着还有一个点啊
要注意了
就是有的地方他是为了什么
为了防止防止什么来防止这个内存的一个碎片
所以说我们就把什么
他就直接把这个物理液
然后根据啊可以什么
可以这个移动性直接进行分组分组织就可以了
就可以解决这个防止碎片
那么就说针对我们所分配这个单页
做了一个性能优化
单页做性能优化
其实它就是为了减少CPU之间的一个
之间跟锁的一个竞争
所以在内存区域增加一个每CPU的一个业集合
就可以了
比如你这要分期
比如我们看啊这个分期的伙伴分配器
是不是他怎么进行分分
看了眼花是吧
我看看我眼花
把这个颜色搭一下
不能换
眼花好看
下一个是不是第四个
第四个我们叫做分期伙伴分配器
他怎么回事呢
首先第一个问题
它这个部分它主要还是专注于什么
专注于某一个内层节点的一个某一个区域
可以这样做的
但是在什么呢
就是他在什么在这个内存区域里面啊
在内存区域的这个结构体成员当中
专门有个什么
专门有个叫什么叫什么叫做什么
他们有一个结
就是在内层区域结构体
我找一下
忘记了在做什么啊
在INCLOUD里面
我下次忘记了
不好意思好
include下面有个LINUX
下面再找到mm z
啊这个专门有个叫做CTRLF啊
叫做tractor
这个就这个其实就是这个存储
你看啊在这个结构体里面
就这地方看到没有
这就找到了
是不是比水线一
那像下面就有一个什么这个地方好啊
在这里
在这个部分里面
在这个ZONE啊
这个结构体里面
下面他就有这么一个成员
看哪个成员呢
叫做一个struct frail
通过这个来处理这个地方
相当于什么呢
就是在内存区域结构体当中当中
对不对
当中的一个什么这个地方不行啊
粘贴不过来是吧
那就直接打叫fal error
是不是用来什么呢
专门用来维护我们这个空闲的一个什么液块
是不是
但是他这个数组下标
你看下面这个数组是A截过来
数组下标它就对应什么呢
对于一块的一个什么一块的一个结束
就这个意思啊
就这个地方啊
对于这个位置看到没有
这个地方就代表结束啊
从这里面来数组的下标啊
就这个地方就代表结束
就是这个位置max order是吧
好那么结构体这个结构体里面它又有一个
你看啊
比如我进去
我在他这个frail error这一方
我再进来是不是
有点卡
等一下
反正就是说当我们打开free error的时候
他有一个成员是不是就是装了一个free list链表
是不是把它连接起来
就是相当于你看刚才我们找到了
是不是
跳过来你没跳过来
没跳过没关系啊
没跳过没关系
其实这个结构很简单
结构体就是就相当于这个结构体frail下划线L
是不是它是什么
就是专门来管这个空闲液块的一个什么数量
空闲液块的一个数量
对不对
就要注意这个问题啊
他是管理这一块的
所以说里面它有个成员结构体
这个里面是管理空闲用的数量
那么这个数量是由哪个装
有个叫做NR下划线负
它是由这个成员去处理才搞清楚
还有一个什么呢
还有一个成员叫做什么呢
就是空闲嗯
空闲这个什么空闲页块链表
空闲页块链表
它是有哪个是这个叫做frail下划线
那么如果大家打开的话
在你那边是可以打的慢
是不是有点慢
就是点击这个地方有点慢啊
以前都反应不过来
是不是就在这个位置
所以你要搞清楚
就是这个来处理的
看这边没有
是不是看一下app
这个没有
那也没关系了
是不是
如果你那里能够打开这个地方的话
那么这里面就有两个是两个成员好
那么针对这两个的话
我们就接下来我们来看这个地方哪个地方呢
这里有个max order
是不是max word
它是最大接
实际上可以分配最大阶
比如加一
那么默认值默认值是11
那么意味着什么呢
就意味着我们伙伴分配器
每次最多可以分配什么
二的十次方
就是二的十次方E就这个意思
max out啊
这地方
应该在前面能看到没有
这是不是减一
你看到没有
有这个的
这个是不是这个胖同学啊啊这个朋友是吧
你看max order11是不是
那么他减个一嘛
对不对
减个一的话
那就相当于什么
实际上刚才我已经讲了啊
告诉大家这就摸清楚了
是不是就是如果你是低版本
可能有些地方可能不太一样的地方
是这个是针对上面那个下面的部分是什么意思
就是刚才没看到max是什么
它这部分是什么
是最大接最大基数
最大接触
那么实际上它可以什么
可以分配的一个最大阶数为加唯一是不是
但是默认值啊
默认值是多少
默认值是11
刚才写了
所以说你十一十一的话
你选一是不是就相当于什么
其实刚才我们看到了它就意味着什么
意味着这个火棒分配器嗯
一次它最多可以分配什么呢
最多可分配二的多少
二的十次啊
十次方隔夜就这个意思
所以说他那个配置里面才能看到的
是不是这上面啊
连马不就跑到这来了
是不是啊
这是这个还有一个什么呢
还有一个就是说比如我们根据分配标志
我们可以得到这个什么首选区域类型
就是说相当于什么相当我们这个申请页的时候
它最低有四个标志
对不对
它组合进行分配了
那么这个分配标志的话
大家可以有时间啊
大家可以研究一下
对不对
那么你比如在内核里面在设计的时候
是不是你你可以看这个标志啊
大家大家可以看一下这个标志
他的研究型的设计啊
你可以看一下在哪里呢
在这个地方有个GFP吗
A b c d e f g
这地方双击看到没有看出来了
最低的你看第一个hi
是不是还有dmsi move
是不是这几个常用的嗯
这几个常用这个是什么
就是相当于这四个啊
常用的是什么意思呢
下面这四个要结合后面才讲啊
就是他就是你申请一页的时候
对不对
那么最低的什么呢
最低的四个啊
最低的四个标志位是用来什么
用来专门指定指定指定的首选
首选的一个内存区域类型
就这个意思
DMI3I高内存DMI是不是不能这么好
那我们现在哎了解这么几个之后
那现在咱们就来看下一个是不是好
那么下一个是什么呢
下一个还有一个是备选的嗯
还有一个是备选
就是备选区域列表
他总是做什么呢
就是说如果首先内存区域
内存节点和区域不能满足分配液
那么它就可以调到下一个区域
今天没有鸿运当头是吧
鸿运当头
那肯定会有的吧
来再研究一下
下面看下一个是好
下一个就是这是第二第三第四个了是吧
咱们看第五个
第五个就是备用备用区域列表
对不对
就是说相当于什么呢
相当于假设是不是假设假设你这个什么呢
你这个首选的啊
首选的内存节点和哪个呢
和区域不能什么
它不能够满足这个什么呢
满足我们这一页分配的请求
你不能满足业分配请求
那么我们就直接从什么直接从备用啊
直接从备用内存区域啊
来借用什么
借用这个物理液
他思路就这样的要搞清楚
那么这个备用区列表它就起到这么一个作用
是不是你比如在啊在这个什么
你在内存节点里面是不是或者在啊区域啊
就是在那个什么在区域里面
你不能满足这个什么
不能满足这个请求
分配页是不是就是一页的分配请求
你不能满足
你不能满足你要求的话
那就通过这个来用了
就是在什么在内存区
是不是在备用内存区域里面
借用这个物理液来进行分配
哎他就这么这么这么一种想法啊
哎那我们了解之后更简单
大家要注意啊
一个内存节点的某一个区域类型
它可以从另外一个内存节点的相同区里面
是不是借用这个物理液
对不对
假设假设这个节点它是零
那么普通区域它可以从什么
可以从一个普通区域里面建物理
是不是
但是高区域就是高区域的一个类型
它可以从什么地区类型借用物理
假设你普通区域啊
你要从这个DM借用物理液
是不是或者低区域不能从高区里面借用
就这个意思
高可以从低里面借
低
不能从高里面借
他的思路就这个意思啊
那么内存节点他那个实力不用去列表在哪里
可以看一下
在内核源码里面看
这里面有一个叫做
在这里面
有一个叫做pg list dctrl f理解啊
date就这个地方
充点卡算好像不行是吧
人骂校长过来换一个版本
高版本啊
在这一篇
mm作为一
注意
啊对对对
你看我没找到地方
就在这两个地方
就这两个成员在笔记里面加上去
这两个看到没有
这两个成员
在这个后面啊
看到没有in a frail跟那个frail list是不是可以了
现在看这个
叫做pg list d啊
这也可以跳过来看看
刚才可能那版本可能不行
有些东西丢了
是不是啊
好你看这地方这里面首先看第一个问题
它有一个什么
你看啊
有一个structure the list
Node
The list
后面有个什么max the list真的干什么
其实我们现在所看到这个位置
它就是一个什么呢
就是一个备用区域列表
就这么个意思啊
OK好
如果各位同学啊
各位朋友们啊
那么大家是后面来的啊
没有跟上这个节奏没有关系对吧
大家可以什么
可以找贝贝老师来领取
这个内存管理的课堂笔记啊
在这里您打开这就可以了
有了吗
在这里面都讲了
你根据这个来就行了
是不是都在这里面三级是吧啊
这这个笔记都给他整好了啊
OK那这个相关笔记的话就找这个
你扫微信也可以啊
加微信都可以
加QQ都可以
那我们就来看下一个了啊
第一个
第二个呢就是包含所有专门有一个枚举
进行设计的
专门有一个叫做
Z y1
看一下在哪个地方
好在在这里也有
一个structure专门指向他
这个看到没有
这两个没有
那上面这个指针他在干什么
Point two to zone
是不是
那这个指针是专门用来指向内存区域的
一个数据结构
下面的IDX就指向什么向内存区域的类型
这个是指向内存区的类型
这两个的区别啊就在地方
但是呢比如我们在什么呢
他怎么去排
怎么去操作
是不是在哪个位置
就相当于给我们看一下啊
嗯这里啊
这个位置
好那这个位置我们搞定之后
还有个什么UMA这个系统
UM系统啊
它只有什么
只有一个备用区域列表
只有一个啊
但是说它是按照什么呢
它是按照区域的一个类型
它是从什么从高到低进行什么进行排
从高到低从高到低进行排序的
大家注意这一点就行了
好那我们掌握这一点之后
还有一个什么
还有一个我们掌握的是区域的一个水线
你从哪里方分的
是不是啊
我们从哪个地方分
就是第六个嗯
这个区域水线嗯
区分线就是相当于什么呢
相当于什么首选的内存区
在什么情况下
对不对
要从备用这个区域里面借用物理
那这个问题就必须从什么
从这个曲水线啊进行了划分的
比如高水线
低水线和最低水线
它也可以这么进行划分的啊
所以说我们刚刚提到的一个首选内存区域
在什么
在什么情况下借用什么呢
它就会从这个嗯从备用的这个区域啊
直接借用什么
借用这个物理一是不是
所以你要怎么分
那么就必须从什么
必须从这个区域水线啊进行什么呢进行划分的
从七首先下手
那么七水线的话它可以分为什么呢
比如刚才讲了叫做还有一个叫做高水线
是不是嗯还出了高水线
还有一个是低水线了
低水线还是这个最低水线
它又分为这三个
最低时用这个来表示是吧
如果你是低水线low high
还有这么一个静态表示
那么这个高水线它是怎么一回事是吧
他是怎么进行高水低水线是吧
他是这么分的
哎大家要看一下啊
你比如这个高水线
高水线是什么意思
就是说如果内存区域的空闲页数它大于什么呢
大于高水线啊
那说明什么
说明这个内存区域他这个内存不足啊
对对内存充足
内存非常充足
就这个意思就是
如果内存区域这个空闲页数它大
以高水线说明内存区域里面啊
他这个内存非常充足
如果是log滴水线
低水线就是什么呢
低水就是说如果内存区的空闲因数
它小于低水线了
那说明这个内存区域的一个内存
它有啊有轻微的不足
那么最低水线就不一样了
最低水线就是说你这个内存区域
它的内存严重不足
那么你如何进行划分这一块
哎刚刚我们不是看到了一个嘛
你看啊他有哪一个呢
有个正water
是不是有水线了
刚才看到一个water
时间发文
有一个water in our work
这个地方这个位置没有
这个是曲水线
对不对
这个是曲水线
那么这个曲水县如果使用啊
我们使用这个曲水线的这个红进行了访问的
他是个红的
123NR等于三
对不对
他这个设计啊
这地方除了是不是这个地方是指什么
是指我们这个区水线区域选项就使用什么
他就使用这个来处理
嗯从这个啊红
啊来访问的
你点击进去就可以看到这里小
退回来在这个结构里面
到这个位置是吧
然后再进行切换到我们对应的一个位置
下面这个地方
看到没有
这就显示出来他是一个枚举的类型
这样的话就很容易得出来
就是你要知道这么一回事就行了
好那我们了解他是这位粉丝之后
那我们应该从哪里过呢
你比如最低水线
最低水线呢
最低水线最低水线以下的内存
它是紧急保留内存
就是内存严重不足的紧急情况下啊
那么才给我们最少紧急保留内存使用
可我们可以什么释放更多内存的一些进程使用
这是这一块啊
但是说啊如果你这个进程也设置了其他
那就不一样了
是不是
但是水线呢我们注意啊
有申请页的时候
是不是你申请页的时候
第一次你尝试最低水线
如果首选内存区
这个呃呃空选页数
是不是它它小于这个小于这个底水线
那就说明什么
你就从这个备用内存去借用
那物理也就可以了
如果你第一次就分配失败了
是不是
如果内存第一次分配失败
那就唤醒所有目标的内存节点
这个这个叫做什么叫液回收线程
有个k sword
是不是k sword这个异步回收
然后再尝试最低水线
那如果这个首选内存区域空选页数
它小于最低水线
那就从备用的内存区域借用
物理也就这么个意思
但是真正应用的时候
大家可以看一下
OK好那我们掌握了一些问题之后
一般是什么呢
比如专门有一个main frail key
是不是进行了重
CTRLF算
专门有一个叫做什么
K
就这么一个对不对
他有这些啊
比如它可以计算出来现在哪些范围内啊
等等啊
你比如说这个1024
可以算出来啊
专门有一个叫做天下啊
下次忘记了
是不是不好意思啊
你看在这东西想得头大头大
是不是在分配里面
有一个叫做page log
page log分配
对啊
在这看一眼方下面
中有一个叫做什么来
INIT下划线
我对这地方
你看他从B端内存没有V2G的设计
就不管它了
嗯这一块啊
现在我们所看到的地方就是什么呢
就是我们在初始化操作的时候
是不是他这个内存
比如中端内存也可以显示
中单里面可以显示
还有一个什么
还有一个水线
那个缩缩水因子它叫做什么
下划线来就这个main下划线FKB
桌面有这么个成员
看到没有
这个
这个它最小是1024
看到刚才我刚才找了个这个是最小字节
这些的是1024
好
我们看这边
在这个位置里面
OK是吧嗯
它是什么
它是最小
使最小空闲字节数嗯
它可以有个限制范围啊
还有一个什么呢
最低档内存小一般是以KB为准
一般是以KB为准
把这个注释到后面看注释这地方可以了
就这么干
那就搞定了
是不是还有个什么水线化因子在这里
CTRLF啊
撕开了就这个了
这个地方看到没有
这个
它就是什么
就是个水性
你现在一个缩放因子
就这么简单啊
默认的情况下是不是默认情况下是是十
是不是啊
是十啊
但是其实我们在在这个内核源码里面都有
看我这边有没有啊
大家等一下
不要急
看完这个有没有在这边
应该是有的
我启动一下
这两个是一个是最小空空弦值减速
一个是水线的一个数换因子
在这里
执行这个系统就可以了
这个差不多了算
下面的内存可以下划线
Fo 4k bs4 k
咦没这个目录啊
真小啊
写错了写错了
嗯这个可以上嘛
是不是
这大小你自己涂啊
这双手看到的第一个算
嗯这个
好这是第一个
看到没有
第二个的话
第二个是不是
叫做啥一样的啊
Cat
嗯他是十
这个没错
默认的
具体来看每一台机器
但是这个是一样的啊
好那这个问题我们就解决了
是不是就可以找出来
好那我们找出这个符号是不是
但是他那个取值是不是
那么在终端显示的话就是十
是不是默认是十
他有个取值范围
就是它的一个取值
等下记号取值范围
取值范围是从什么
从1~1到1000
这个取值范围大
可是那么另外一个是什么呢
就是你计算最低水线的方法
它有这么几个方法
就是我们如何计算
对不对
我们如何计算这个最低啊
嗯最低水线的一个方法啊
比如这个令下划线free
刚才看到pages你就等于多少呢
就等这个命下划线frail有一个什么KBATIS
它所对应的一个什么页数就可以了
这是第一个好
另外一个是什么呢
log m e m里面有一个什么pages
那这个就相当于什么
就是所有的所有的这个低端内存区域嗯
内存区域当中的一个什么呢
当中的一个伙伴分配器管理的一个什么管理呃
页数的一个什么页数的一个嗯和
是不是就这个还有一个什么
还有一个是高端
对不对
那高端这一块的计算方法下来
你比如这个高端内存区域
他的一个什么最低属性
就等于直接指向指向就可以
里面有个叫做什么除上1024
是不是忘记了
等一下在
有这么一个层面
就这个看看这个这个这个magic magic什么pages
通过这个来处就行了
他个整数
通过它
记得下划线pages
我们就通过这个这么一个成员啊
去除1024
是不是除掉零四之后就相当于什么
就是相当于我们要限制啊
但是范围也可以限制
就限制范围也可以限制范围嗯
你可以限制这个范围
限制范围的话
我们可以限制到什么
你可以先比如32
到时到一八十八
这是也是可以的
不是以内的啊
一类的一定要注意这个是以内的啊
什么意思
他这样的操作就是说我们这个指针啊
这个里面只能说之前那个肠炎
对不对
它是在内存区火爆分配器里面
页数在内核初始化过程当中
它它这个什么这个引导内存的分配器
他就分配出去的物理液
它不是火旺分配器的管理
就这个意思
你分配出去了
不管他的事是不是还有一个什么
刚刚才那个是高端
对不对
这是高端啊
那么如果低端的话
他是这么计算的啊
是高端内存的计算方法
是不是现在看高端
如果是高端内存区域
它的一个什么最低水线
你怎么算
哎刚才是高端
现在是低端
低端低端同样的道理
直接用刚才讲的
就这个成员好吗
用这个in free pages直接什么就通过他乘上
乘上刚刚除上这个了
哎这指向这个成员
是不是
然后再除上最低属性
Long page
LOL就这个简称除上这个是不是就可以了
是不是就OK了
就是把什么呢
把这个比例就相当于把这个月的
按照比例分配到每一个什么呢
执行早就分配到每一个低端内存区域嗯
那么计算低水线和高水线的方法啊
你比如说低水线它有个最低水线加增量
高水线就是最低水加量乘以二啊
两个部分是不是这个公式很简单啊
大家可以推上嗯
就是有时间大家可以先研究一下
这个我们就不在意的研究是不是研究很很很费
这个时啊
可以了是吧啊
那么解决这个问题之后
还有一种什么呢
还有种你要注意啊
我们要防止过度借用
是不是你借用少没关系
借用多有问题
所以说这个高高区域的一个类似是什么呢
比低区域的这个内型内存相对要少一些
高血压好一些
那么如果是低区内存比较少
所以资源非常稀缺
是不是比如它有些特殊用途
比如啊比如DMI区域
它用于外围设备和内存之间的数据传输
那时候我们为了防止高区域
高区内类型
这个过度借用地区的这个物理液的话
那所以就说低区类型
它需要采用什么成防卫措施
保留保留一定数量的物理
你再怎么借
我也不会借给你
就这个意思啊
就像什么呢
就是一个内存节点的某一个区域类型
就从另外一个内存节点
相同的群类型的建筑物理
最后啊应该是什么呢
毫无保留的兼容
但是你至少保留一个
就是内存区域里面它有一个什么宿主
用于什么呢
城方保留页
存款保留页
刚才你看到了啊
就最低最低的那一个就这个叫做哇塞
看这里看
这里看这
max in r是不是这里面他做什么
就是内存区域内存
其它就是使用
好我们来看一下
就这个意思就搞定了
算好
搞定这个之后还有这个问题
是不是还有什么问题呢
还有就是我们来了解的第几个了
第
七个
好第七个

## 参考

[Linux内核《伙伴分配器_块分配器》_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1xi421o73f/?p=7&vd_source=4a018e55005b433dc9d72a8e969a1c5f)