各位朋友们大家好
我是威克
这节课主要是和大家分享有关于slab分配器
那么在讲解这有关六个问题之前
我们先要掌握第一个问题就是基础啊
那么基础知识第一个我们要掌握什么呢
在LINUX内核当中
我们必须要掌握一个什么叫做列表的一个映射
页表映射是什么意思呢
我们现在啊想一下
在LINUX内核当中
这个页表映射它是什么
是指将什么呢
虚拟地址啊
以哪个以物理地址之间
他就建立一个什么呢啊对应的关系
对应关系的一个过程
这就是我们必须要知道的
比如啊举个例子
比如比如什么呢
这个X86他的一个什么架构啊
中那内核呢使用什么
使用多级列表进行地址什么呢
映射X86
但是LINUX内核它采用什么四级列表
最高级别是PGD好
就是每一集都包含
指向下一下一级页表的一个指针
它通过什么来逐级进行来查找
这种找到对应的一个什么物理啊
物理的一个什么呢
就是物理页面对应的一个物理地址
那就是我们经常讲嘛
LINUX使用什么呢
叫做四级列表
好私企页表结构从最高级嗯
从最高级这个PGD开始
他就是每一级那就包含一个什么呢
指向下一级嗯
列表的一个什么指针
所以说他通过什么呢
逐级进行什么查找它最终他就找到什么呢
物理地址啊
物理页面啊
物理页面对应的一个什么物理地址
这是我们必须要知道的一个核心概念
是什么意思呢
就是当一个进程他访问虚拟地址的时候
LINUX内核他就通过什么相应的一个列表
这个页表项来确定对应的一个物理页面
那如果某一个虚拟地址
它没有映射到物理页面的话
那肯定会发生什么呢
异常啊
发生缺页异常
那么我们是通过什么呢
页表映射机制
操作系统就能够实现什么虚拟内存管理
包括内存的一个什么呢
共享和内存的一个什么保护
这就是为什么要了解这个虚拟啊
多虚拟地址和物理地址以及页表映射
它们之间的一个什么关系
我就全部给他讲完了
这是第一个
那么了解第一个之后
接下来你还了解第二个嗯
第二个是什么呢
我们要知道内内核当中的一个什么内存布局
什么意思啊
我们就来看一下啊
嗯就是说内存布局就是LINUX内核当中
内存布局它是一个非常复杂啊
整个它就涉及到我们物理内存管理
包括页表映射
还有什么虚拟地址
那么至少我们要掌握一个什么呢
比如你要掌握这个
比如第一大内存我们叫做什么
叫做这个log memory
老memory
这是低端内存
那么这个低端内存是什么意思呢
它主要是低于什么D3GB的物理内存区域
就被作为什么保留使用
包括我们的数据站A站和代码上这一块的低端
这一块
还有一个就是什么呢
高端嗯
高端内存我们叫做什么hi memory
高端内存
高端内存就是3GB以上的物理内存区域
就称为高端内存
比如你在32位系统当中
你就无法直接访问
需要通过这个什么来映射关系啊
来进行访问的高端内存
还有一个就是内核的一个什么虚拟地址空间嗯
这一块什么意思
在LINUX内核当中
我们把它叫做什么
叫做分割式的一个虚拟地址空间
将4GB的虚拟地址
整个空间把它平均分成两个部分
上半部分是用户进程空间
对不对
那下半部分呢是我们什么内核进程空间
就说你内核虚拟地址空间它就分成两个嘛
两部分嘛哪两部分呢
比如上半部分
上半部分它主要是用于什么呢
用户进程的一个地址空间
那么它的地址是从什么0XC啊
后面就是1234567啊
这个啊
然后一直到什么呢
一直到这个0X0X嗯
八个F123412348个F
这是上半部分啊
那下半部分呢嗯下半部分它是用于什么
内核进程的一个地址空间
内核进程地址空间
我们是从什么从0X几个零啊
八个0123412348个零到什么
来到0XB7个F好
现在我们所看到这个它就是什么呢
就是内核内存的一个布局
你比如啊这个内核虚拟地址空间
分为上下半部分
它的区分在哪个地方
那么除了这个内核虚拟地址空间布局之后呢
还必须要掌握一个什么
叫做内核的一个模块区域
内核模块区域
它主要是用于什么加载和运行
一些动态加载的内存模块
内核模块
那么这个区域内它就包含什么
一个是数据
另外一个是代码
还有一个就叫做物理的一个什么叶宽区域
物理页框区域是什么呢
就是用于管理我们这个什么
用于管理系统当中所有的一个物理页框
那么包括用什么呢
页框链表
还以及包括什么
已经被分配给进程的一个什么缓冲期
夜空它就包含了这些相关的信息
所以大家一定要掌握这个点好
当我们掌握了一点之后
那我们接下来呢就更加容易学习下一个知识点
下一知识点什么意思呢
那我们啊在学习什么
在学习这个创建分配释放SLABEL是什么意思
首先第一个问题
我们必须要掌握的就是这个点SLABEL它是什么
Slabel
它本身它就是一种什么内存的分配器
主要是用于什么呢
管理我们这个操作系统
内核的一个动态内存分配在LINUX内核当中
那我们广泛使用什么呢
slab分配器对不对
那么通过它的核心思想
就是通过我们预先划分好大小相同或者是不同
两个人相邻块肯定相同啊
那么这个内存块来提高什么呢
内存分配和释放的一个效率
那slab分配器呢
他将这些slab分类对不对啊
快速主要是快速满足各各种大小的一个
对象分配请求
并且他通过什么呢
这个缓存机制重新啊
就是从用重新使用已经释放了对象所占的slab
这样的话就可以减少什么呢
频繁的分配啊和释放这个什么操作啊
这样的话它就不会影响什么系统的一个性能
这是我们大家必须要知道的一个点
但是你看啊
其中我们还要知道由于什么呢
这个slave这种算法就是他这个分配算法
他直接什么呀
他使用的是catch
使用catch存储的一个什么内核对象
那么sleep这个缓存
slab缓存还有一个什么呢
它是从什么
从这个缓存当中来分配和释放和释放对象
然后再进行什么呢
销毁保存的这个过程
它就必须要什么来定一个什么
定一个k memory
什么呢
Catch
那么这个对象是不是
然后注意啊
那么这个对象的话
然后对就是之后对齐进行什么初始化
初始化之后呢
那么这个方程就包含了多少
包含32个字节的一个对象
这是我们也必须要知道的
那么当我们使用这个slab分配器的
注意啊
slab分配器的话呢
它是什么
就是在catch和object加入slab分配器
他在什么时间和空间上当中进行了什么
折中方案选择就这一块
那么另外一个我们必须要知道什么
slab的一个什么状态
第二个要掌握什么呢
LINUX当中的一个label状态
它会为哪几种状态呢
首先我们来看第一个
第一个是叫满的啊
第一种第二种是什么呢
只有部分的
第三种是什么空的
哎有同学可能就没听说过啊
其实这个你不要着急
这个分别是什么意思啊
我会给大家进行进一步来介绍啊
大家不要慌是吧
第二个我们讲这个我们讲是吧啊
这个也讲了这个现在我们进行讲好
下面来看一下满的是什么意思
满它就相当于什么
你这个lab分配器当中他的什么呢
所有对象就被什么被标记为使用
就是用码了
还有一个是部分部分就属于什么呢
就是这个slab中它的一个什么对象
看中的一个对象有什么呢
有的背是有的啊
嗯有的被什么呢
被标记为使用
那有的呢就被标记为什么呢
空闲
所以它只占部分啊
这是我们要知道的
看到这是第二个部分
空大就很简单了
空的话就是SLABEL的什么所有对象哎
所有对象他就被什么呢
所有对象被标记为什么
空闲的标记为空前的
就这个意思
这是大家知道的啊
好那么我们知道这个问题之后
那接下来呢接下来我们就来看另外一个点了啊
哪哪两个点呢
它的一个优点
那它的优点在哪里
就是为什么要采用它
是不是它的优势在哪个地方
接下来我们来看第三个level
它的一个优点
缓存分配器所提供的一个什么优点
那有哪些优点呢
第一个就是你这个slab分配器它怎么样呢
它是还支持什么十来个控制器啊
它还支持一个什么支持通用的一个对象
通用对象的一个初始化
这样的话呢它就可以什么可以避免了
为同一个什么呢
同一个目的而对什么呢
而对一个对象进行什么重复的进行初始化嗯
这是他的第一个优点
也是第一个优势
就是你在B分配器它支持什么通用对象初始化
从而避免了为同一个同一个目的
而对一个对象重复进行什么初始化
第二个是什么呢
就是内核它通常还需要什么呢
依赖于什么对小对象的一个什么分配
所以他们会在什么
会在这个系统生命周期内部进行什么
来进行无数次啊
无数次的分配
这是第二个
第三个是什么呢
第三个因为你这个slab缓存
你要注意啊
slab缓存这个分配器
它是通过对什么等类
类似于什么大小的大小的一个对象
进行什么缓存而所提供的这种功能
然后呢
这样的话
他也可以什么来避免一些常见的碎片问题
就是他这三个的一个特点
那么除了第三个的话呢
还有什么呢
第四个由于什么
你这个slab分配器
它还可以什么来支持一些硬件缓存
硬件缓存对齐和一些着色还允许什么呢
不同的这个方程当中的一个对象
它所占用相同的一个什么占用对象好
占用相同的方程行
从而他可以什么来提高
这个方程的一个利用力啊
并且获取什么呢
更好的一个性能啊
这就是他的一个什么优势
所以我们在学的过程当中
只要掌握达到这个点就行了
那这是有关于这个啊
那现在的话呢我们就来看下一个了
下一个是第四个
第四个我们知道什么呢
slab缓存它的创建对不对
分配和释放我们进行进一步来分析一下是吧
Ok
我们来看一下啊
第一label这个分配器
他的一个什么创建分配和释放
那么这三个他分别怎么操作呢
他也一样
是非常简单啊
有关于slab分配
它创建
对不对
但是整个过程它所使用啊
就是你创建所使用的一个什么呢
函数是哪些
是不是
那这个大家一定要搞清楚啊
啊就是你创建一个slab分配器的话呢
你只要记住一个非常简单
叫做KMM下划线
有一个什么呢
catch下划线create
诶
你再了解就可以了
这个是什么意思呢
你看啊当我们用到啊对应的API函数
第一个啊
这个是用于什么
创建一个新的slab缓存
那么他接收多个参数
包括slab缓存的名称啊
slab缓存每个对象的大小
包括他的对齐方式
这些都在里面
这其中的一个函数
另外一个必须要掌握k memory下划线catch什么呢
a lock这个函数这个函数是什么呢
因为你创上面你创建好slab缓存之后
再通过这个函数啊
就是用于指定那个slab缓存当中分配一个对象
他只接受一个参数啊
他只写什么
他所需分配对象这个slab方程的一个什么指针
并且返回一个指向什么
已经分配对象的注意
另外一个是什么呢
KMM下划线catch嗯
消耗线有个什么frail
什么意思啊
那么我们通过这个函数释放
先前就是通过这个函数释放啊
释放哪个呢
释放前面这个函数所分配的一个什么对象
就可以了
但是他接收两个参数
这个函数就有两个参数
一个是什么
一个是他所在的slab缓存的一个指针
另外一个就是他要什么呢
释放了一个对象的一个什么指针
这两个不一样嗯
还有一个要记住的就是k mm下划线
它有一个什么catch下划线ROY这个函数啊
啊那么这个函数是销毁于什么呢
销毁我们之前通过这个函数
创建了一个slab缓存
它只接受一个仓
只要一个参数
它只是什么呢
只是你释放了16
我换成了一个指针
因为你看通过这个函数啊
嗯通过这个LINUX内核要注意啊
那我们这个LINUX内核中的一个什么这个函数
对不对
它它的一个什么这个函数啊
它所使用
那我们是怎么去使用这个函数的
对不对
大家不要慌啊
你看这是其中的一个另外一个是什么呢
等一下告诉大家怎么去写这个代码
那么我们除了第一个字号
那么还有什么
还比如第二个
你像这个的话
你是要从哪里来
也是从那个slave create里面得到之后啊
你创建成功
你才可以往下分配对象
如果你不成功
你根本就没有办法区分配对象
这是我们必须要知道的好
接下来就有一个什么有个flash flash释放了对吧
各位各位同学们
press释放啊
嗯这还有一个什么这个视放对象
这个是放前面那个这两个是配这个
这个是在释放前面
那个这个是用的方式释放了一个对象
那我们现在带大家看一下
你写一段代码
你自然就明白了
是不是嗯
那我们怎么进行实现呢
对不对啊
你看看啊
给我们写代码代码的大概思路啊
大家来看一下
有点卡啊
等一下好
现在可以了
啊这个进来之后呢
我们单击这个文件
新建文本文件啊
直接把它保存一下
保存之后呢
我是放在桌面好
SLABEL缓存啊
嗯他的一个什么呢
PS写完之后点C是非常
那我们就可以在什么
在这里面来带大家来看一下啊
然后
是比较小
可
这个文字啊嗯
还是八
线变大一些了啊
好我们来看一下
接着我们就来看这个代码啊
他怎么去实现呢是吧
我们学习关键点是什么呢
在于你知道怎么去用
那么我们在编写这个程序的过程当中
组建第一步啊
怎么说呢
将对应的一个什么头文件
include监控里面什么
你要实现边有关于什么呢
LINUX下面专门有一个什么model
这个模块点H应该写上
接下来第二个第二个是什么LINUX
小写不大
写不写错了
下面有一个什么内核corner的点H
第三你要干什么
你要通过这个label
LINUX下面装了一个什么SLABELH啊
你把这个头文件写好了
选好之后
那你要分配的一个结构呢
包括你定义的指针
我们就可以在下面进行实现啊
首先我们来定义一个结构数据啊
我定my structor s
发括号里面我就定一个date i下划线D
我先把定好
那这个我们定好之后
你要定个初始化的一个模块
tt static什么呢
int双下划线IIT好
现在我们设置什么呢
初始化模块就相当于什么呢
my买什么slabel model
I i t
OK就写一个word就行了啊
第一个你就写好了啊
就是这个我有关于这个模块
然后接着CTRLC把它复制
下面一个是什么呢
你退出吗
退出的话呢
你这地方就不能是int了
你就直接来一个什么呢
word就行了
这里不是IIT
这里是什么EXIT这里不是IT
你要保持一致啊
EX2T你看现在是全部写好了
写好中间还有两个模块
那个模块
比如model m o d u l e下划线
license l i c n s e括号GP
这是第一个应该是好的啊
模块的一个什么内核模块的初始化和退出
那就直接这个model下划线IIT
第一个model下划线EXIT啊
你把这个函数名换到这来
等你执行就可以了
看下C这不就可以了
把整个框架就出来了
好那么这个框架出来之后
那下一个我们是怎么用的呢
大家不要着急啊
关了DD的话
首先你要创建一个指针啊
就是要定一个指针
这个kim catch啊啊static
然后structure接的什么
接KMM下划线
catch cs h e星号
my什么来catches
哎哎那我怎么知道这个在哪里呢
你点这个掩码分析呢
你看等一下比较慢啊
看完了没反应过来
其实这个可以跳到我们的掩码分析里面
大家注意啊
好那有的同学可能就讲老师
那这个什么有关于stru k mm啊
就是有关LINUX内核当中
那我们这个它这个结构体要注意啊
就是有关于它这个结构体嗯
所在的一个什么呢
掩码文件
嗯那么它所在的页码文件我可以看一下啊
大家可以观察一下
不要着急啊
我们要分析源码
要打开它文件夹上找到这个地步
内核源码我们来看一下啊
好没问题
没问题
看着LINUX下面没有找到SLABEL
你
好你看下面这个结构体
马里
可以CTRLF
点它
好在这里
嗯嗯专属功能
啊你看它就有什么有这些对应的成员嘛
他就是一个结构体类型
那么有关于他这个类型里面它有什么呢
有多个成员是吧
多成员你比如第一个成员lock
第二个是size
第三个NR下划线object
还有objects啊
还有一个括号就是函数指针
函数指令带了一个没有参数吗
它是为的什么意思啊
大家不要着急啊
有关于这个设计
他这样的第一个为什么要使用这个什么呀
它来访问
其实用它来访问这个目的主要是什么呀
嗯因为内存池的一个操作的话
要锁加锁叫做什么呢
就是同步访问缓存的一个什么缓存的一个复制
所使用的
那你这个size呢
就是返程当中它每一个对象的一个什么方小
接着OBJSOBJS它是属于什么呢
就是属于我们当前它是属于当前这个方程当中
对象的一个什么数量是多少
那object呢它就是指向分配给什么
给缓存的一个内存块的一个指针
但是你这个内存块它就包含了什么呢
多个对象就这个意思
后面这个函数指针
该函数指针
这个函数指针它是用于什么
目的
是用于初始化
初始化我们先分配的一个什么对象
大家注意啊
就是此函数他就接收一个什么呢
way的新
他接受这个V的性类型的一个指针
类型的类型参数
你看有关这个我给大家放大了
就是你在编写代码的时候
你这个是必须要知道的好
那这个问题我们搞清楚之后
接下来我们就来看下一个了啊
下一个编写了个代码
对刚才那个代码那里打开一下桌面
还有一个
open啊
嗯打开
那么open之后
那首先我们的第一步啊
首先你第一步要做什么呢
大家看啊
你上面订好之后嘛
通过他去访问
所以到这儿来的话
那我们就应该是什么呢
通过这个my catches等于调那个函数
KMEM下划线
你看都出来了啊
看那个下划线什么catch专门对应的什么create创建
首先第一个参数要写创建的名称
就my catch catch test是吧
就这么写啊
然后接着说
接着你要求它大小
后面size名称后面有个size菜还没有对齐嘛
哎size size of啊
求大小
求大小的话
你就直接structure那个数据就行了
就是my structure
My and my struct
嗯就可以了
完了之后呢
零好后面类型我就用slab下划线
专门一个什么hw catch flag嘛
你看这个我们就备好了
这个有点大是吧
把你改一下
把set改一下
Want
28才大概22
小一点
看到没有好
那么这个问题啊
这个搞清楚
那么当我们这个创建这个时候
创建时lab缓存对吧
创建完之后
你要实现一下判断
如果什么呢
如果取反而他不成功
如果买下划线这个my catch嗯
成功取款失败
他不执行一些
以失败取款变为真
它就往下执行
那么就return杠什么呢
1MM有同学
那老师这个是什么意思呢
这个代码在我们的内核当中
它是返回一个什么错误的代码语句
要注意啊
是C语言写的复数是表示错误的嘛
你看啊这个地方就是返回错误代码的一个语句
你要搞清楚return
所以说现在我们所看到的一个什么呢
比如他这个杠error NO memory
是不是它主要是返回了一个什么问题
就意思就是表示你这个内存不足的错误
所以我们一定要知道它的缺点在哪里
我就告诉大家了
然后我们也可以什么呢
我们可以提醒用户啊
是不是我打印个信息告诉用户PCIF双引号啊
不是不好意思啊
写毒蛇眼喷车开双引号
首先第一个你输出错误啊
1corner q12下放线1R2
对不对
这双引号放在前面就是KAKI下划线ERR
这个是错误啊
错误的话比较短的一个信息就是什么呢
创建slab缓存失败
你也给正常情况下
对不对
那我们一定要用什么用英文进行翻译
你不能用中文啊
你要写上什么啊
你再写上一个创建slave换成什么呢
失败就可以了
那么它的具体翻译就
failed的f a r e failed to create slabel catch
就是你创建了一个缓存失败
然后就封号好
那么当我们创建成功之后
他就不能执行下来了
人家搞清楚成功之后又往下走了
成功之后
你创建那个什么呢
slab缓存
你看啊
这地方我们是创建
创建slab缓存对吧
下面成功了啊
就是你创建web缓存成功之后
我们必须要往下走
那我们就直接使用什么
就使用这个my catches
my catches进行什么对象啊
进行对象的一个分配和释放
分配和释放诶
你看下面就要走了
你要创建一个什么
你这里你要创建一个结构体啊
大家注意啊
嗯咱们自己创建
那我创建一个什么呢
我们分配
那我就是直接写一个结构体的
接收它啊
structure structure什么呢
刷这个my上面那个STRUCTUSTRUS
就是你这个类型要跟这个保持一致
你是来接受他的信息的吗
嗯所以说你这里创建之后
你就写一个这个my object
等于就可以了
等一等于之后怎么做呢
等于你就使用第二个函数了
k memory下划线
catch下划线再来一个什么a log分配
你是配什么
你是记这个的分配的
即my catches
金马开启式分配好
后面你是GFP标准啊
下划线看到这就可以了
接着你再次来判断判断什么呢
my truck my object好
my object啊
满足这个条件
我们就往下执行
然后执行什么
你要打印输出信息
双引号就可以了
后面我们就return返回内存不足是吧
你返程不足嘛
杠1no memory
NO mm就可以了
这里面最前面我们输出一个什么corner的下划线
E空一格啊
到底后面的后面是什么呢
就是分配啊
分配内存啊
失败是不是你是从哪里来
从开启时从十内部缓存分配内存失败
就相当于什么呢
就是你直接从什么
从这个意思就是从slab缓存当中
缓存中分配什么呢
这个分配内存的一个什么对象是吧
嗯嗯怎么翻好
failed失败啊
To a loca
LOC好了
catch什么memory分配内存啊
哎对象内存memory object from slabel catch
就这么翻译了
开玩笑啊
英语不好
是不是我英语不是很好
但是你看的话
你也可以看到从sleep方程当中分配对象失败
是不是分配个对象失败好
那这个没写好了
这个写好之后
那么我们在使用完之后啊
使用完之后一定要先释放它了
使用完之后我们就要释放它的一个对象
下面我们就使用什么
使用这个分配的内存进行什么操作
哎各种各项操作啊
嗯就可以了
操作完之后呢
我们就要学会什么呢
事后我们已经分配的一个什么内存
将这个走了
那首先怎么做呢
K嗯memory下划线有一个什么catch phrar
CHE下划线frail不就可以了吗
括号里面写my买什么catches
My catches
逗号后面就写这个my object
你是什么
先释放那个对象了
object这个对象my object是先释放对象
释放完对象之后
这个程序最后我们就return起来
return0就可以了
这是没问题
好没问题之后呢
那我们操作过程中
你退出模块的时候
推出模块的时候
一定要记得要释放这个什么缓存啊
所以最后下面就判断一下嘛
如果称为空气
不需要时候就if1件买下划线K
其实我们下划线开启时
只要它是不为空
那就通过KMM下划线啊
catches下划线这个什么drop
那就写上my catches不就可以吗
释放完之后
我们就将这个指针my catches嗯
给它设为什么设为空
你看整个思路啊
哎我们的设计就已经全部写完了啊
这是有关于什么
你在写代码过程当中
我们怎么去用这个函数
你看是不是就可以搞定了
好大家可以到什么程序啊
到那个操作系统上进行执行一下啊
要注意这点就行了啊
这就是刚才我给大家所讲解的这个部分
那么接下来什么
接下来我们就来看下一个了
下一个我们讲的是什么呢
有关于这个什么
有关于这个VMACC跟哪个呢
跟KMC它如何进行使用
嗯什么意思啊
就是比如we maco它是什么
它在LINUX内核当中
它主要是用于什么呢
用于这个内核空间分配这个动态内存
但是用于什么
需要大款连续虚拟地址空间的这种情况嗯
他主要是做这个事情
大家一定要明白啊
那么除了这个以外的话呢
它还有一个什么呀
还有一个就是你要注意的一个点
就是说相当于什么
相当于就是说你当用到这个函数的时候
那就必须是什么呢
内存内存空间
你不能什么不能被这个用户直接访问的这种
所以我们要理解这个点啊
那只要当我们理解这个点之后
那么下一个问题是什么呢
你看啊
我们来看第一个点
第一个点就是VMACO
为什么这个函数OK这个函数啊
它的一个作用作用是什么呢
由于在这个什么
在内核空间中分配这个什么动态内容啊
那通常它是用于什么用
你需要这个什么大块
连续的一个什么大块连续的一个虚拟地址空间
它的需求就这地方大家要注意
那这个v medical
这个函数是通过调用内部那个VMACOEXE
包括node这个函数实现
他从什么从虚拟空间当中找到一个什么
有足够大的一个连续区域
将它映射到物理内存
那么它所返回的就是一个小弟子
他的意思就是该函数从哪里来
从虚拟地址空间哎当中来找到一个什么主
找到一个足够大
并且啊他要什么呢
并且要连续的一个区域啊
连续区域联系之后呢
并且要将什么呢
要将它的一个将它映射啊
映射到内圈
映射到物理内存上面
物理内存对不对
但是他的一个返回值
返回值是什么
返回值是你是他自己所分配的呃
返回值是所分配的一个什么内存区域的
一个起始虚拟地址啊
其实新低
你看你要掌握到这个点
基本上就差不多了
就没多大问题了
大家要搞清楚啊
第一点第二点我就搞定了
是吧好哎这是这个函数啊
但是我们用这个函数的时候呢
内核这个函数的时候要注意为什么呢
由于什么
由于那个VMC的函数它是什么呢
它分配的是内存
是在内核空间
在内核空间就不能
为什么不能被用户所访问
所以说我们用这个函数的时候
它专为什么对应的函数就是当使用此函数
必须用KFRA开服的这个函数啊
来什么呢
来释放这个锁分配的内存
OK啊第一个我们就解决了
解决完第一个之后呢
那接下来我们就来解决第二个
第二个函数是什么
K melo
他也是在内存里面分内内核内存分配的啊
这个函数啊
同样的他是干什么的
该函数它是从哪里啊
从我们预先嗯
从你E先所创建好的一个什么slab缓存
或者啊直接从什么
直接从这个页框当中来分配的一个物理内存
并且将其进行什么映射到相应的一个虚拟地址
它的一个什么呢
返回值
返回值为所分配嗯
内存区域的一个什么内存区域的一个指针
就这个函数
但是啊这个函数跟上面那个函数不一样
这个函数呢它主要那是用于分配什么
比较小的一个比较小的
并且是固定的一个大小的内存块
而不是什么
而不是大块连续
而不是大概连续的一个虚拟地址空间嗯
这种啊可以什么呢
一线分配好
它效果可能更好
但是当我们用这个函数的时候
你要释放空间
就是当使用此函数就必须用什么呢
用CFA注意啊
用carefree函数进行释放所分配的一个内存
这是我们大家要掌握的
下面我们来看一下啊
这两个函数啊
由于这个函数它在内核当中
它又是怎么执行的呢
各位同学们啊
MIUX内核当中
你这个函数啊
它所在的一个什么所在的文件在哪里呢
掩码文件在哪里呢
你就直接找到什么
找到mm
等到这个mm诶
看到这来了啊
你找到这个mm下面还有一个VMV
看到没
为MC里面看啊
这个函数CTRLF啊
VMACC这个函数LLOC括号有这个函数了
能看到
没有微free
k free肯定是有的啊
二三
看到没有
啊v ma看到没有
明白了
你看用于分配什么
分配这个虚拟
你看用分配这一块
那我们在使用的过程当中
大家要什么呢
如果实在不太清楚啊
你可以什么
你可以翻译一下吗
自己翻译啊
比如你当你用这个函数的时候
哎它是分配什么
分配虚拟连续内存
虚拟啊
这是个连续的意思嗯
分配虚拟的联系内存
那么它只有一个参数size
看到没有
他这个size的话呢
就是你分配的一个大小
那么它是从哪里边
它是从这个页面级别分配足够的一个页面
对不对啊
让它映射到连续的一个什么内核虚拟空间当中
把映射啊
你看映射到连续的一个内存
虚拟内内核的一个虚拟空间里面去
但是它使用肯定是非常严格
就不用讲了
但是他返返返回的是什么呢
就他返回指针
就是指针指向分配内存或者出现错误的时候
是不是就它返回值
那么就回错误啊
是不是要么就返回所分配的内存
就是调那个函数所用到
你看v Mac就从内核源码分析我们就搞清楚了
你看一下啊
嗯这是VMACA
它的一个什么内核源码分析给你搞出来了
那我们掌握这个内核源码
这还有什么
还有个key ma
对不对
那么有关于什么呢
LINUX内核当中他的一个什么KMCKMC
它也是什么所在的一个文件里面去嘛
你找到它就行了
lab com点C嗯
在里面就找到就可以了
贴my lock括号
那是四分k size都讲了啊
调用这个函数
对呀
分配开辟设备缓存O
分配这个版本啊
slab缓存GC
给这个词
那得找了
找不到这个函数
哪个地方括号只有这四个
我这两个分配对象负责在哪里
在这里它导出的函数
在这里
等一下再跳过去啊
啊对要么就是我这个版本啊
版本
嗯这个的话应该我记得他有一个对应的函数
在里面
你可以看一下啊
就是key ma那个函数内层次
它也可以进行分配使用
就是我们的chemical内存词
比如下面分配很多个啊
是不是KMC多多个字节
它可以进行分配啊
但是内核它有对应的源码跟它对应关系
我在看一个头文件
看看有没有他
应该是可以有的
这下子我忘记在哪个地方了
看下来B点H有没有他在这里
我没找到他买了没有
我们来看一下啊
啊是的
我总说我真的是忘记在哪里
所以在这里
chemical这个指针函数没有它所分配的GFP
没一个size
一个GFP两个参数吗
这不就出来了
在这里
不好意思
刚才找错地方了
他的掩码分析看
好我把它放到这来啊
这是有关于这个函数
但是说这个函数的话呢
它对应的什么
就是我们所看到的这一把代码
那么如果大家如果大家有时间
那么你可以怎么样
可以针对这个代码进行什么进一步的分析
但是我们要搞清楚有关于什么呢
这个KMACO注意啊
chemical的size size是什么呢
就是你首先判断size是否编译的时候
常量就是它根据大小进行分配
那你这个GFP
它是属于一个什么GP的一个模式
就说你在分配的时候
你不能答应什么chemical max catch size啊
不能大于它
它专门用函数进行给你定位
你看下面有分配这个吗
啊比如说井号NTF这个没有被定义
就执行了index了
原本就执行if以及判断
那么这个large chemical logies是什么意思
他是这个函数是进行什么大块内存分配的
就实现大块内存分配
那下面这个slog是不是社保
后面他就有一个什么
有个对应的这个MC开启后面有一个两个下划线
最后就走直接返回它
返回它的话
你就要调到这个函数里面
你就返回到这个来
嗯它就会调用到这个函数里面来
可以调到他啊
因为这个没跳过去
跳过去大家可以看得到啊
那么有关于什么呢
你看啊有关于刚刚我们所讲的这个什么
就这个啊
Kemeloo
是不是
那么CBA实力就接着什么js level缓存就可以了
他这个就是它所对应的函数的一个
什么实力是吧
你怎么分析看啊
嗯你直接定个函数
然后再第一个什么呢
你要分配的大小怎么进行处理
就直接到这边来就可以了
接这个位置是吧
就可以了
它的一个分配啊
其实我们也可以什么
大家可以看一下
我记得我在VIP里面是给大家讲过的
大家可以看一下啊
大家可以先看一下有关于这两个函数
我记得在VIP讲内存分配的时候
我是给大家讲过的
咱们1180
你看啊
内核内存管理KMELOO
对对对
你看VMACO的
大家先听一下
你在内核源码分析是讲过里面有执行的啊
你双击来观察一下
大家好
我是微课
这节课我们继续来学习第三小讲
v ma案例实战分析
现在我们来看第大点
VMACO跟v free的一个函数原型
什么意思
we medical这个函数它的功能是干什么呢
就是内核啊
专门用于什么这个函数
来申请这个动态内存空间
那么这个函数它分配的内存呢是来自于什么
内核地址空间
它是一个什么非连续的一个物理内存
那么在整个操作过程中
系统会自动啊
系统内部的会自动进行什么对齐和管理
这点我们要搞清
楚
并且呢它可以用来什么来分配
这个各种大小的一个内存块
但是由于分配过程当中他需要什么
需要进行啊锁操作
所以说这个VMACO它不能在什么
不能在中断上下文
或者是说不可什么来存入代码中进行使用
这一点我们要明白嗯
但是我们还注意一点
我们使用这个函数啊去分配这个内存啊
它是物理内存
就是物理地址
它一般是不连续的
但是虚拟地址呢它是连续的
那分配内存空间
它就被映射到映射到什么
映射到我们这个内核数据当当中了
用户空间也是不可见的
就是我们使用这个函数
那现在我们来看看一下该函数的一个延伸
那么当我们调用那个函数的时候
它带有一个参数
那么这个参数呢是size
Size
就是你要申请的一个什么字节数啊
大家一定要注意这个点就可以了啊
那么调那个函数的话呢
它返回的是什么
它返回是你创建了一个地址
期间的一个什么虚拟地址
如果分配失败
他就直接返回一个什么空子
那我们在使用该函数的时候啊
使用该函数的时候
那么它会有什么
会有一个对应的WIFRAIL进行来释放这个空间
那么WIFRAME这个函数对不对
它是用于什么呢
释放这个动态分配的一个内存空间
具体来讲要注意啊
里面它有一个什么
有个ADD
看到这里有个ADDADD是一个什么呢
是一个指针的一个参数
就是表示啊你要释放的一个内存的一个首地址
就是我们在执行这个函数之前
你看下面有个什么
有个bug下划线啊
括号里面有个什么in下划线
NMI括号
那么这个红注意啊
这个红呢它是判断什么
这个红它是判断是是否除以M啊
是否除以AMI啊
上下文NMI是指什么分非屏蔽中断
就这个意思
那么如果当前正处于什么呢
NMI的话
这个上下文那么就会触发这个bug错误
并且停止运行了
就是这个
那第二个的话就是2388这一行的话
就说k m e m like下划线frail a ADD
这个函数说明了什么
清除我们该内存啊
对应的一个什么呀
对应的这个k m n like这种工具相关的信息
要注意这个问题的
还有下面就会调用到什么
就是2389这一行MMT
然后下半期sleep1
那这个是干什么的
这个红这个红是用来判断什么
判断我们就是进行了休眠判断
那么如果当他不在中啊
就是他不在这个中断上下文
并且允许我们这个什么呢
就是进程它允许这个睡眠
他就可能会进入这个睡眠状态
否则的
否则他就跳过这个步骤啊
大家注意这个问题可以了
那么后面它就掉了一个什么两个下划线
v FA DDR这个才是什么
这个函数就是2392行这一条
这一条语句是真正的释放这个内存块
所占用的一个什么物理页面要注意啊
一定要注意这个问题
我们用这个函数的时候
大家注意它有个什么双下划线开头的啊
就表示什么表示内部实现的函数
不建议什么
不建议大家直接调用
就说我们电脑肯定是v free
你不可能直接用两个下划线
v free要注意这个问题啊
你不建议直接掉啊
所以最后的话你看它有个导出
看没有export syr
就是导出该函数的符号
供其他模块进行使用
就是好
刚才啊大家所看到我所讲的这个视频啊
它是属于什么
属于我们VIP系统学习班里面
专门给大家讲解这个什么内核分析的
因为今天晚上我所讲的内容是属于什么
是在公开课里面给大家分享一下
那如果大家要具体细节
我们还有后面那个操作
你看里面写个GP
现在进行修改一下
你看model
你看
好LINUX
这个是大写
看到没有
七点开为MC点C
你看你要把这个改为什么搞个小写
上面大写不对啊
再次麦克一下好Mac成功之后
那么接下来我们就来实现啊
看结果直接写什么呢
第一哦要编辑内核里面去哦
好in search mode
然后再来一个什么
再来一个v melo test
点什么点KO啊
d message7杠11beta
那么现在大家所看到的提示性
就是说加载模块时调用那个VMC
那么那个指针刚才讲我们那个指针呢point成memory
就是这个指针啊
那个指针的话呢就收到这个什么
收到我们这个ma的一个什么
非为MC的一个返回值
所以它分配什么
分配一个非连续的内存区域的起始地址
注意啊
现在阴性结果啊
我们啊就知道什么
该虚拟地址的起始地址就是0X4个
F a b d b80033000
这是他的一个什么地址啊
完了之后呢
那么如果我们卸载这个模块
那就是mod啊
mod什么呀
再来一个V
KOREADMSG杠C
那么现在我们所看到这个提示就是什么呢
你调那个v frame这个函数成功了
是不是你看正常退出这个内核啊
就这么简单
大家一定要注意这个细节问题
所以这两个函数的配套使用
我已经全部都给他讲了
那么大家在学的过程当中啊
有问题我们再进行进一步的讨论
那么本节课这个内容就到此结束
好你看啊
这这刚才诶他走了是吧
那么刚才所讲的这个是有关于什么LINUX内核
源码分析
其实我们在学内核的时候也要掌握这几个点
哪几个点呢
首先你要掌握有关于内存
有啊内存有关于什么呢
内核当中的这个进程管理里面进程管理理念
那这里我们啊给大家设计的是一共有20讲
20讲
每一讲它都有什么呢
对应的这个什么啊
视频啊
笔记啊
还有掩码都在这里啊
大家有时间就直接拿这个掩码去执行跑一下
比如你在这个红黑树是不是他这个执行
你看点C文件
你右接你打开这个就可以了
把这个跳过来了是吧
你看你就可以根据这个代码进行了测试一下
但是要注意啊
我们这里所写的
其实跟我写那个内核模块源码是一样的
如果理念这些不一样啊
你怎么初始化
是不是怎么进行设计一个函数
将一个元素抄到红黑树当中
怎么执行是吧
哎怎么构建一个什么啊
对应整棵红黑树怎么做是吧
那么做完之后呢
我们在什么呢
你在这个对应的用户空间
我又是怎么去调用的
同学在user这边用户空间里面怎么调用啊
就是用户的使用
比如在设计的时候
你看啊
你看点C
可以参考这个看看没有
嗯这是一个啊
这个我们在读函数里面
看在主函数第多少个节点
1万个是吧
1万个的话
你比如这个test node里面
我们就有什么红黑树节点
r b q video是不是ARGUMENTED
然后再往下面
比如我们怎么去插入操作是吧
怎么抄这个节点是吧
然后怎么去删除操作
然后呢我们包包括这个什么检测操作啊
输出怎么去搜索主函数
我们怎么去调
你要学会什么去执行衡量这个代码我前面写好
就说大家有时间直接拿去运行一下就可以了
OK那是有关于这个红黑树这一块
所对应的个案例来讲
这里现在我们就来看下一个了啊
嗯那我们除了这个什么呢
就刚才除了这个进程管理之后呢
我们还学这个什么内存管理了
内存管理里面一共有34啊
有34家
然后再往后面我们就到什么设备驱动
设备驱动我们不是做驱动应用开发
在这里的话只讲16讲
有关于什么USB啊
PCI啊
是不是等等啊
V4L2字符设备驱动啊
第四个就是文件系统文件
到这里我们讲一下讲啊
还有后面就是网络协议栈
网络协站的话
在这边我们一共讲了22讲
22讲
把网络写一段之后
我们会讲什么
中断管理
终端管理理念
我们一共讲了什么呢
然后17讲17个项目
后面就到基础了
那么有关于基础部分它有什么基础部分
有关于操作系统汇编啊
以及相关的这个操作系统有关的
这个为什么要讲17讲呢
这17讲就是帮助
就是有的同学他是非计算机专业出身的
来学这个内核
是不是
所以说你要注意啊
然后就说你学内核是这样这个来了嗯
那么除了这个以外的话呢
我们还有一个什么
再往后面就到这个面试了
因为我们学完内核之后
大多数啊同学他主要是什么学内核
进行进一步的什么呃
去跳槽
或者是你找工作
对不对
那么当别人问到内核的时候
这里面我们给大家准备了什么
17道这个有关于内核的面试题
同时在这边我也给大家整理好了
在这里在这里面公开课里面
我记得应该整好了
看到没有
还有关于面试题
这个大家可以看一下这个有没有100道双截
就有一次出去的时候干嘛去了
学校好看啊
这里面100刀
你看比较慢
你往后面等就行了
有点卡
一共有20页

## 参考

[B站字幕转换 | 牧尘的NAS小站 (dreamlyn.cn)](https://www.dreamlyn.cn/html/bsrt.html)